<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Complete</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #121212;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      text-align: center;
      padding: 20px;
    }
    .icon {
      margin-bottom: 20px;
    }
    .icon svg {
      width: 60px;
      height: 60px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    p {
      font-size: 16px;
      color: #b3b3b3;
      margin-bottom: 30px;
    }
    .loader {
      border: 3px solid #1DB954;
      border-radius: 50%;
      border-top: 3px solid transparent;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    .error {
      color: #ff4d4f;
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      background-color: rgba(255, 77, 79, 0.1);
      max-width: 80%;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="icon">
    <svg viewBox="0 0 24 24">
      <path fill="#1DB954" d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.48.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"></path>
    </svg>
  </div>
  <h1 id="title">Authentication in Progress</h1>
  <p id="message">Processing authentication...</p>
  <div class="loader" id="loader"></div>
  <div class="error" id="error" style="display: none;"></div>

  <script>
    // Parse query parameters
    const params = new URLSearchParams(window.location.search);
    const error = params.get('error');
    const token = params.get('token');
    const userData = params.get('userData');
    
    // Update UI elements
    const titleElem = document.getElementById('title');
    const messageElem = document.getElementById('message');
    const loaderElem = document.getElementById('loader');
    const errorElem = document.getElementById('error');
    
    // Handle error from OAuth flow
    if (error) {
      titleElem.textContent = 'Authentication Failed';
      messageElem.textContent = 'There was a problem authenticating with Spotify.';
      loaderElem.style.display = 'none';
      
      errorElem.style.display = 'block';
      errorElem.textContent = error;
      
      // Notify opener window
      if (window.opener) {
        window.opener.postMessage({
          type: 'spotify-auth-error',
          error
        }, '*');
        
        // Close this window after a short delay
        setTimeout(() => window.close(), 5000);
      }
    } else if (token) {
      // We have a token in the URL params
      try {
        // Parse the user data if it's provided
        const user = userData ? JSON.parse(decodeURIComponent(userData)) : null;
        
        titleElem.textContent = 'Authentication Successful!';
        messageElem.textContent = 'Redirecting back to Spotifriends...';
        
        // Send data to opener and close
        if (window.opener) {
          window.opener.postMessage({
            type: 'spotify-auth-success',
            token,
            user
          }, '*');
          
          // Close after a short delay
          setTimeout(() => window.close(), 1000);
        } else {
          messageElem.textContent = 'Authentication complete. You can close this window.';
          loaderElem.style.display = 'none';
        }
      } catch (err) {
        console.error('Error parsing user data:', err);
        titleElem.textContent = 'Authentication Error';
        messageElem.textContent = 'Error processing authentication data';
        errorElem.textContent = err.message;
        errorElem.style.display = 'block';
        loaderElem.style.display = 'none';
      }
    } else {
      // This is just the initial callback page load
      // The server will handle the OAuth code and redirect back with token
      titleElem.textContent = 'Authentication in Progress';
      messageElem.textContent = 'Connecting to Spotify...';
    }
  </script>
</body>
</html>